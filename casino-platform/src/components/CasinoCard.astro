---
export interface Props {
  data: any;
  index: number;
}

const { data, index } = Astro.props;

// EXTRACT DATA FROM NESTED GROUPS
// We destructure deeply to make the variables available to the template
const {
  name,
  logo_url,
  rank,
  affiliate_url,
  isActive
} = data;

const metrics = data.metrics_group || {};
const offer = data.offer_group || {};
const features = data.features_group || {};

// Map variables for easier use
const rating = metrics.rating || 0;
const payout_speed = metrics.payout_speed || "-";
const welcome_bonus_headline = offer.welcome_bonus_headline || "";
const min_deposit = offer.min_deposit || "-";
const vip_high_roller = offer.vip_high_roller || false;
const banking = features.banking || [];
const providers = features.providers || [];
const license = features.license || "-";
const mobile_app = features.mobile_app || "-";
const customer_service = features.customer_service || "-";

// Logic for Rank Styling
const getRankTier = (r: number) => {
  if (r === 1) return 'tier-gold';
  if (r === 2) return 'tier-silver';
  if (r === 3) return 'tier-bronze';
  return 'tier-muted';
};

// Logic for Stars
const fullStars = Math.floor(rating);
const hasHalf = rating % 1 >= 0.4;
const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);

// Inline SVGs
const StarFull = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor" width="1em" height="1em"><path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/></svg>`;
const StarHalf = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor" width="1em" height="1em"><path d="M288 376.4l.1-.1 26.4 14.1 85.2 45.5-16.5-97.6-4.8-28.7 20.7-20.5 70.1-69.3-96.1-14.2-29.3-4.3-12.9-26.6L288.1 69 288 376.4zm175.1 98.3c2 12-3 24.2-12.9 31.3s-23 8-33.8 2.3L288.1 439.8 159.8 508.3C149 514 135.9 513.1 126 506s-14.9-19.3-12.9-31.3L137.8 329 33.6 225.9c-8.6-8.5-11.7-21.2-7.9-32.7s13.7-19.9-25.7-21.7L195 150.3 259.4 18c5.4-11 16.5-18 28.8-18s23.4 7 28.8 18l64.3 132.3 143.6 21.2c12 1.8 22 10.2 25.7 21.7s.7 24.2-7.9 32.7L438.5 329l24.6 145.7z"/></svg>`;
const StarEmpty = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor" width="1em" height="1em"><path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.7-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0zm0 79L235.4 187.2c-3.5 7.1-10.2 12.1-18.1 13.3L99 217.9 184.9 303c5.5 5.5 8.1 13.3 6.8 21L171.4 443.7l105.2-56.2c7.1-3.8 15.6-3.8 22.6 0l105.2 56.2L384.2 324.1c-1.3-7.7 1.2-15.5 6.8-21l85.9-85.1L358.6 200.5c-7.8-1.2-14.6-6.1-18.1-13.3L287.9 79z"/></svg>`;

// Icon Resolver
const iconMap: Record<string, string> = {
    "NetEnt": "netent.svg", "Microgaming": "microgaming.svg", "Play'n GO": "playn-go.svg",
    "Evolution": "evolution-gaming.svg", "Pragmatic Play": "pragmatic-play.svg", "Thunderkick": "thunderkick.svg",
    "Yggdrasil": "yggdrasil-gaming-logo.svg", "Visa": "visa.svg", "Mastercard": "mastercard.svg",
    "Skrill": "skrill.svg", "Neteller": "neteller.svg", "Bitcoin": "bitcoin.svg",
    "MiFinity": "mifinity.svg", "Jeton": "jeton.jpg", "Paysafecard": "paysafe card.svg",
    "Bank transfer": "bank transfer.svg"
};

const resolveIcon = (item: any, type: 'method' | 'name') => {
    if (item.icon) return item.icon;
    if (item.logo) return item.logo;
    const key = item[type];
    if (key && iconMap[key]) return `/uploads/${iconMap[key]}`;
    return null;
};
---

<div class="casino-card" style={`animation-delay: ${index * 0.1}s`}>
  <div class="casino-row-main">
    
    <!-- 1. Rank & Identity -->
    <div class="rank-name-wrapper">
      <div class="rank-col">
        <div class={`rank-box ${getRankTier(rank)}`}>{rank}</div>
      </div>
      <div class="casino-info-col">
        <img src={logo_url} alt={name} class="casino-logo" />
        <div class="name-rating-stack">
          <span class="casino-name">{name}</span>
          <div class="mobile-rating">
             <div class="stars">
              {Array(fullStars).fill(0).map(() => <Fragment set:html={StarFull} />)}
              {hasHalf && <Fragment set:html={StarHalf} />}
            </div>
            <span class="mobile-rating-text">{rating}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Bonus -->
    <div class="bonus-col">
      <span class="bonus-highlight" set:html={welcome_bonus_headline}></span>
      <span class="bonus-sub">New Player Offer</span>
    </div>

    <!-- 3. Rating -->
    <div class="rating-col">
      <div class="stars">
        {Array(fullStars).fill(0).map(() => <Fragment set:html={StarFull} />)}
        {hasHalf && <Fragment set:html={StarHalf} />}
        {Array(emptyStars).fill(0).map(() => <Fragment set:html={StarEmpty} />)}
      </div>
      <span class="score-text">{rating}</span>
    </div>

    <!-- 4. Payments -->
    <div class="payment-col">
      {banking && banking.slice(0, 4).map((m: any) => {
        const iconSrc = resolveIcon(m, 'method');
        return iconSrc ? 
          <img src={iconSrc} title={m.method} class="pay-img" alt={m.method} /> : 
          <span class="pay-icon">{m.method}</span>;
      })}
    </div>

    <!-- 5. Actions -->
    <div class="action-col">
      <a href={affiliate_url} target="_blank" rel="nofollow noopener" class="btn-play">Claim Now</a>
      <button class="toggle-details" onclick="this.closest('.casino-card').querySelector('.casino-details-panel').classList.toggle('active'); this.classList.toggle('active');">
        Details <i class="fa-solid fa-chevron-down"></i>
      </button>
    </div>
  </div>

  <!-- DETAILS PANEL -->
  <div class="casino-details-panel">
    <div class="detail-box">
      <span class="detail-title">Banking options</span>
      <div class="tag-list">
        {banking && banking.map((m: any) => {
           const iconSrc = resolveIcon(m, 'method');
           return iconSrc ? 
             <img src={iconSrc} title={m.method} class="bank-tag-img" alt={m.method} /> : 
             <span class="text-tag">{m.method}</span>;
        })}
      </div>
    </div>

    <div class="detail-box">
      <span class="detail-title">Games & Providers</span>
      <div class="tag-list">
        {providers && providers.map((p: any) => {
           const iconSrc = resolveIcon(p, 'name');
           return iconSrc ? 
             <img src={iconSrc} title={p.name} class="provider-tag-img" alt={p.name} /> : 
             <span class="text-tag">{p.name}</span>;
        })}
      </div>
    </div>

    <div class="detail-box">
      <span class="detail-title">Bonus Stats</span>
      <div class="bonus-row">
        <span class="bonus-label">Min Deposit</span>
        <span class="bonus-value">{min_deposit}</span>
      </div>
      <div class="bonus-row">
        <span class="bonus-label">Payout Speed</span>
        <span class="bonus-value">{payout_speed}</span>
      </div>
      <div class="bonus-row">
        <span class="bonus-label">License</span>
        <span class="bonus-value">{license}</span>
      </div>
      <div class="bonus-row">
        <span class="bonus-label">Wagering</span>
        <span class="bonus-value">35x</span>
      </div>
    </div>

    <div class="detail-box">
        <span class="detail-title">VIP Features</span>
        <div class="detail-content">{vip_high_roller ? "High Roller Program Available" : "Standard Loyalty Program"}</div>
    </div>

    <div class="detail-box">
        <span class="detail-title">Mobile App</span>
        <div class="detail-content">{mobile_app}</div>
    </div>

    <div class="detail-box">
        <span class="detail-title">Customer Service</span>
        <div class="detail-content">{customer_service}</div>
    </div>

    <div class="panel-footer">
      <div class="license-info">
        <i class="fa-solid fa-shield-halved"></i> Licensed by {license}
      </div>
      <span class="review-link">Read Review &rarr;</span>
    </div>
  </div>
</div>

<style>
  /* Reuse styles from previous step */
  .casino-card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
    position: relative;
    opacity: 0; 
    animation: fadeUp 0.6s ease-out forwards;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
  }

  .casino-card:hover {
    transform: translateY(-5px);
    border-color: #555;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    z-index: 2;
  }

  .casino-row-main {
    display: grid;
    grid-template-columns: 80px 1.5fr 2fr 1fr 1.2fr 160px;
    gap: 15px;
    align-items: center;
    padding: 15px 20px;
  }

  .rank-col { display: flex; align-items: center; justify-content: flex-start; }
  .rank-box {
    width: 42px; height: 42px;
    font-size: 1.05rem; font-weight: 900;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.3s ease;
  }
  .casino-card:hover .rank-box { transform: scale(1.1); }
  
  .tier-gold { background: linear-gradient(180deg, #FFF2B0 0%, #FFD700 50%, #C69C3A 100%); color: #1a1205; box-shadow: 0 10px 22px rgba(255, 215, 0, 0.45); }
  .tier-silver { background: linear-gradient(180deg, #F5F5F5 0%, #C9CCD1 100%); color: #1a1a1a; box-shadow: 0 6px 14px rgba(180, 180, 180, 0.35); }
  .tier-bronze { background: linear-gradient(180deg, #E2B07A 0%, #B87333 100%); color: #1a1205; box-shadow: 0 6px 14px rgba(184, 115, 51, 0.35); }
  .tier-muted { background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%); color: #999; box-shadow: inset 0 0 0 1px #333; }

  .rank-name-wrapper { display: contents; }
  .casino-info-col { display: flex; align-items: center; gap: 12px; }
  
  .casino-logo {
    width: 50px; height: 50px;
    border-radius: 50%;
    object-fit: contain;
    background: #111;
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .casino-card:hover .casino-logo { transform: rotate(360deg) scale(1.1); }
  
  .casino-name { font-weight: 700; font-size: 1.2rem; color: #fff; line-height: 1.2; }
  .mobile-rating { display: none; margin-top: 6px; align-items: center; gap: 8px; }
  .mobile-rating .stars { font-size: 0.8rem; display: flex; gap: 2px; }
  .mobile-rating-text { font-size: 0.8rem; color: #ddd; font-weight: 600; }

  .bonus-col { display: flex; flex-direction: column; justify-content: center; }
  .bonus-highlight { color: var(--brand-gold); font-size: 1.1rem; font-weight: 700; margin-bottom: 2px; }
  .bonus-sub { color: #fff; font-size: 0.85rem; }

  .rating-col { display: flex; align-items: center; justify-content: center; gap: 8px; }
  .stars { color: var(--brand-gold); font-size: 0.8rem; display: flex; gap: 2px; }
  .casino-card:hover .stars { animation: pulse 1s infinite; }
  .score-text { font-size: 0.9rem; font-weight: 700; color: #fff; }

  .payment-col { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
  .pay-icon { background: #fff; border-radius: 3px; padding: 2px 5px; color: #111; font-size: 0.7rem; font-weight: 700; display: inline-block; }
  .pay-img { height: 28px; width: auto; max-width: 50px; border-radius: 2px; background: #fff; padding: 2px; vertical-align: middle; object-fit: contain; }

  .action-col { display: flex; flex-direction: column; align-items: center; gap: 16px; }
  
  .btn-play {
    background: var(--cta-bg);
    color: #000;
    border: none;
    padding: 10px 16px;
    width: 100%;
    border-radius: 5px;
    font-weight: 900;
    font-size: 0.85rem;
    text-transform: uppercase;
    box-shadow: 0 4px 0px #b37400, 0 4px 12px var(--cta-shadow);
    position: relative;
    overflow: hidden;
    text-align: center;
    display: block;
    cursor: pointer;
  }
  
  .btn-play::after {
    content: '';
    position: absolute;
    top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: none;
  }
  .btn-play:hover { transform: translateY(-2px); box-shadow: 0 6px 0px #b37400, 0 8px 20px var(--cta-shadow); filter: brightness(1.1); }
  .btn-play:hover::after { animation: sheen 0.6s ease-in-out; }

  .toggle-details { background: none; border: none; color: #777; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; }
  .toggle-details:hover { color: #fff; }
  .toggle-details.active i { transform: rotate(180deg); }

  .casino-details-panel {
    display: none;
    background-color: #0d0d0d;
    padding: 25px;
    border-top: 1px solid var(--border-color);
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    animation: fadeUp 0.4s ease-out;
  }
  .casino-details-panel.active { display: grid; }
  
  .detail-box {
    background: #181818;
    border: 1px solid #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    display: flex; flex-direction: column; gap: 10px;
    transition: transform 0.2s;
  }
  .detail-box:hover { transform: translateY(-2px); border-color: #333; }

  .detail-title { color: #fff; font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; display: block; }
  .detail-content { font-size: 0.9rem; line-height: 1.5; color: #ccc; }
  .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }

  .text-tag { background: #222; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: #ddd; border: 1px solid #333; display: inline-block; margin: 2px; }
  .bank-tag-img { height: 28px; background: #fff; padding: 2px; border-radius: 4px; object-fit: contain; }
  .provider-tag-img { height: 28px; width: 28px; background: #fff; padding: 1px; border-radius: 50%; object-fit: contain; }
  
  .bonus-row { display: flex; justify-content: space-between; border-bottom: 1px solid #2a2a2a; padding: 8px 0; font-size: 0.9rem; }
  .bonus-row:last-child { border-bottom: none; }
  .bonus-label { color: #888; }
  .bonus-value { color: #fff; font-weight: 600; text-align: right; }
  
  .panel-footer { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #2a2a2a; padding-top: 15px; margin-top: 5px; font-size: 0.8rem; }
  .license-info { display: flex; align-items: center; gap: 8px; color: #777; }
  .review-link { color: #777; font-weight: 600; cursor: pointer; }
  .review-link:hover { color: var(--brand-gold); }

  @media (max-width: 900px) {
    .casino-row-main {
      grid-template-columns: 1fr 1fr;
      grid-template-areas: 
        "header header"
        "bonus bonus"
        "payments payments"
        "action action";
    }
    .rank-name-wrapper { grid-area: header; display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center; }
    .bonus-col { grid-area: bonus; text-align: center; background: #222; padding: 10px; border-radius: 6px; }
    .payment-col { grid-area: payments; margin-top: 5px; }
    .action-col { grid-area: action; margin-top: 10px; }
    .rating-col { display: none; }
    .mobile-rating { display: flex; }
    .casino-details-panel { grid-template-columns: 1fr; }
  }

  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  @keyframes sheen { 0% { left: -100%; } 100% { left: 100%; } }
</style>