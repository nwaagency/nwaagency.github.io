---
import Layout from "../../layouts/Layout.astro";
import CasinoCard from "../../components/CasinoCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const geos = ["de", "at", "ca", "nz", "ie", "global"];
	return geos.map((geo) => ({ params: { geo } }));
}

const { geo } = Astro.params;
const allCasinos = await getCollection("casinos");

// Filter Logic
const filteredCasinos = allCasinos.filter((casino) => {
	const data = casino.data;
	// Handle nested or flat structure for backward compatibility
	const isActive = data.identity_group?.isActive ?? data.isActive ?? true;
	if (!isActive) return false;

	const targeting = data.targeting_group || {};
	const allowed = targeting.allowed_geos || data.allowed_geos || ["global"];

	return allowed.includes("global") || allowed.includes(geo);
});

// Sorting Logic
const sortedCasinos = filteredCasinos.sort((a, b) => {
	const rankA = a.data.identity_group?.rank ?? a.data.rank ?? 999;
	const rankB = b.data.identity_group?.rank ?? b.data.rank ?? 999;

	if (rankA !== rankB) return rankA - rankB;

	const ratingA = a.data.metrics_group?.rating ?? a.data.rating ?? 0;
	const ratingB = b.data.metrics_group?.rating ?? b.data.rating ?? 0;
	return ratingB - ratingA;
});

const geoNames: Record<string, string> = {
	de: "Germany",
	at: "Austria",
	ca: "Canada",
	nz: "New Zealand",
	ie: "Ireland",
	global: "World",
};
const countryName = geoNames[geo] || "Global";
const pageTitle = `Best Online Casinos in ${countryName} - 2025`;
---

<Layout title={pageTitle}>
	<!-- 1. STICKY HEADER -->
	<header class="site-header" id="siteHeader">
		<div class="nav-bar">
			<div class="brand-logo">
				<i class="fa-solid fa-crown"></i> EXCLUSIVE OFFERS <span>.VIP</span>
			</div>
			<nav class="nav-links">
				<a href="#">Home</a>
				<a href="#">Bonuses</a>
				<a href="#">Reviews</a>
			</nav>
			<a href="#" class="btn-contact">Contact Us</a>
		</div>
	</header>

	<!-- 2. HERO SECTION -->
	<section class="hero-section">
		<div class="hero-container">
			<span class="pre-title">Find the best online casinos</span>
			<h1 class="hero-title">Welcome to Your VIP Casino Advantage</h1>
			<p class="hero-subtitle">
				We rigorously test and review thousands of casinos to bring you the
				safest, most lucrative VIP offers available in {countryName} for 2025.
			</p>
			<div class="stats-grid">
				<div class="stat-card">
					<span class="stat-number">500+</span>
					<span class="stat-label">Exclusive Bonuses</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">{sortedCasinos.length}</span>
					<span class="stat-label">Verified Casinos</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">150+</span>
					<span class="stat-label">Active Players</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">24/7</span>
					<span class="stat-label">Expert Support</span>
				</div>
			</div>
		</div>
	</section>

	<!-- 3. MAIN CONTENT (Casino List) -->
	<main class="main-content-area">
		<div class="casino-list-container">
			<!-- List Items -->
			<div class="casino-list">
				{
					sortedCasinos.map((casino, index) => (
						<CasinoCard data={casino.data} index={index + 1} />
					))
				}
			</div>

			{
				sortedCasinos.length === 0 && (
					<div style="text-align:center; padding: 40px; color: #666;">
						No casinos found for this region.
					</div>
				)
			}
		</div>
	</main>

	<!-- 4. NEWSLETTER -->
	<section class="newsletter-section">
		<div class="newsletter-container">
			<h2 class="newsletter-heading">Join the Winners Circle</h2>
			<p class="newsletter-sub">
				Get exclusive high-roller bonuses and VIP codes sent directly to your
				inbox weekly.
			</p>
			<form class="newsletter-form" onsubmit="event.preventDefault();">
				<input
					type="email"
					placeholder="Enter your email address"
					class="newsletter-input"
					required
				/>
				<button type="submit" class="newsletter-btn">Get VIP Access</button>
			</form>
		</div>
	</section>

	<!-- 5. FOOTER -->
	<footer class="site-footer">
		<div class="footer-grid">
			<div class="footer-col footer-brand">
				<div class="brand-logo" style="color: var(--brand-gold);">
					<i class="fa-solid fa-crown"></i> EXCLUSIVE OFFERS
				</div>
				<p>
					The world's premier destination for exclusive casino bonuses and
					unbiased reviews. We help you play smarter and win bigger.
				</p>
				<div class="social-icons">
					<a href="#"><i class="fa-brands fa-twitter"></i></a>
					<a href="#"><i class="fa-brands fa-facebook-f"></i></a>
					<a href="#"><i class="fa-brands fa-instagram"></i></a>
					<a href="#"><i class="fa-brands fa-telegram"></i></a>
				</div>
			</div>
			<div class="footer-col">
				<h4>Quick Links</h4>
				<ul class="footer-links-list">
					<li><a href="#">Top Rated Casinos</a></li>
					<li><a href="#">Newest Bonuses</a></li>
					<li><a href="#">No Deposit Offers</a></li>
					<li><a href="#">Crypto Casinos</a></li>
					<li><a href="#">Casino Reviews</a></li>
				</ul>
			</div>
			<div class="footer-col">
				<h4>Support</h4>
				<ul class="footer-links-list">
					<li><a href="#">Contact Us</a></li>
					<li><a href="#">About Us</a></li>
					<li><a href="#">Editorial Guidelines</a></li>
					<li><a href="#">Responsible Gambling</a></li>
					<li><a href="#">Sitemap</a></li>
				</ul>
			</div>
			<div class="footer-col">
				<h4>Legal</h4>
				<ul class="footer-links-list">
					<li><a href="#">Privacy Policy</a></li>
					<li><a href="#">Terms & Conditions</a></li>
					<li><a href="#">Cookie Policy</a></li>
					<li><a href="#">Disclaimer</a></li>
				</ul>
			</div>
		</div>
		<div class="footer-bottom-bar">
			<div class="copyright-text">
				&copy; 2025 Exclusive Offers VIP. All rights reserved. 18+ Please gamble
				responsibly.
			</div>
			<div class="footer-bottom-links">
				<i class="fa-solid fa-shield-halved"></i> SSL Secure Connection
			</div>
		</div>
	</footer>
</Layout>
