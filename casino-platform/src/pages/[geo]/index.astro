---
import Layout from "../../layouts/Layout.astro";
import CasinoCard from "../../components/CasinoCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const geos = ["de", "at", "ca", "nz", "ie", "global"];
	return geos.map((geo) => ({ params: { geo } }));
}

const { geo } = Astro.params;
const allCasinos = await getCollection("casinos");

// Filter Logic
const filteredCasinos = allCasinos.filter((casino) => {
	const data = casino.data;
	const core = data.core_identity || {};
	const rankVis = data.ranking_visibility || {};

	// Handle isActive (Nested or Root fallback)
	const isActive = core.isActive ?? data.isActive ?? true;
	if (!isActive) return false;

	// Handle Targeting (Nested Group)
	const allowed = rankVis.targeting_group || data.allowed_geos || ["global"];

	return allowed.includes("global") || allowed.includes(geo);
});

// Sorting Logic
const sortedCasinos = filteredCasinos.sort((a, b) => {
	const rankVisA = a.data.ranking_visibility || {};
	const rankVisB = b.data.ranking_visibility || {};
	const metricsA = a.data.ratings_metrics || {};
	const metricsB = b.data.ratings_metrics || {};

	const rankA = rankVisA.rank ?? a.data.rank ?? 999;
	const rankB = rankVisB.rank ?? b.data.rank ?? 999;

	// Primary: Rank
	if (rankA !== rankB) {
		return rankA - rankB;
	}

	// Secondary: Rating
	const ratingA = metricsA.rating ?? a.data.rating ?? 0;
	const ratingB = metricsB.rating ?? b.data.rating ?? 0;

	return ratingB - ratingA;
});

const geoNames: Record<string, string> = {
	de: "Germany",
	at: "Austria",
	ca: "Canada",
	nz: "New Zealand",
	ie: "Ireland",
	global: "World",
};
const countryName = geoNames[geo] || "Global";
const currentMonth = new Date().toLocaleString("default", { month: "long" });
const currentYear = new Date().getFullYear();
const pageTitle = `Best Online Casinos in ${countryName} - ${currentMonth} ${currentYear}`;
---

<Layout title={pageTitle}>
	<!-- 1. STICKY HEADER -->
	<header class="site-header" id="siteHeader">
		<div class="nav-bar">
			<div class="brand-logo">
				<!-- Logo Image -->
				<img
					src="/uploads/logo_no_bg.png"
					alt="Executive Offers Logo"
					class="header-logo"
					onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
				/>
			</div>
			<nav class="nav-links">
				<a href="#home">Home</a>
				<a href="#">About Us</a>
				<a href="#bonuses">Bonuses</a>
				<a href="#">Reviews</a>
			</nav>
			<a href="#contact" class="btn-contact">Contact Us</a>
		</div>
	</header>

	<!-- 2. HERO SECTION -->
	<section class="hero-section" id="home">
		<div class="hero-container">
			<span class="pre-title">Find the best online casinos</span>
			<h1 class="hero-title">Welcome to Your VIP Casino Advantage</h1>
			<p class="hero-subtitle">
				We rigorously test and review thousands of casinos to bring you the
				safest, most lucrative VIP offers available in {countryName} for 2025.
			</p>
			<div class="stats-grid">
				<div class="stat-card">
					<span class="stat-number">500+</span>
					<span class="stat-label">Exclusive Bonuses</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">{sortedCasinos.length}</span>
					<span class="stat-label">Verified Casinos</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">150+</span>
					<span class="stat-label">Active Players</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">24/7</span>
					<span class="stat-label">Expert Support</span>
				</div>
			</div>
		</div>
	</section>

	<!-- 3. MAIN CONTENT -->
	<main class="main-content-area" id="bonuses">
		<div class="casino-list-container">
			<!-- List -->
			<div class="casino-list">
				{
					sortedCasinos.map((casino, index) => (
						<CasinoCard data={casino.data} index={index + 1} />
					))
				}
			</div>

			{
				sortedCasinos.length === 0 && (
					<div style="text-align:center; padding: 40px; color: #666;">
						No casinos found for this region.
					</div>
				)
			}
		</div>
	</main>

	<!-- 4. NEWSLETTER -->
	<section class="newsletter-section" id="contact">
		<div class="newsletter-container">
			<h2 class="newsletter-heading">Join the Winners Circle</h2>
			<p class="newsletter-sub">
				Get exclusive high-roller bonuses and VIP codes sent directly to your
				inbox weekly.
			</p>
			<form 
                class="newsletter-form" 
                name="newsletter" 
                method="POST" 
                data-netlify="true"
                id="newsletterForm"
            >
                <!-- Hidden Input for Netlify -->
                <input type="hidden" name="form-name" value="newsletter" />
				<input
					type="email"
                    name="email"
					placeholder="Enter your email address"
					class="newsletter-input"
					required
				/>
				<button type="submit" class="newsletter-btn">Get VIP Access</button>
			</form>
            <p id="form-message" style="display:none; margin-top:1rem; font-weight:bold;"></p>
		</div>
	</section>

	<!-- 5. FOOTER -->
	<footer class="site-footer">
		<div class="footer-grid">
			<!-- Column 1 -->
			<div class="footer-col footer-brand">
				<div class="brand-logo">
					<!-- Logo Image -->
					<img
						src="/uploads/logo_no_bg.png"
						alt="Executive Offers Logo"
						class="footer-logo"
						onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
					/>
				</div>
				<p>
					Discover top-rated online casinos with massive bonuses, secure
					gameplay, and fast payouts.
				</p>
			</div>

			<!-- Column 2 -->
			<div class="footer-col">
				<h4>QuickLink</h4>
				<ul class="footer-links-list">
					<li><a href="#">Home</a></li>
					<li><a href="#">About Us</a></li>
					<li><a href="#">Bonuses</a></li>
					<li><a href="#">Reviews</a></li>
				</ul>
			</div>

			<!-- Column 3 -->
			<div class="footer-col">
				<h4>Resources</h4>
				<ul class="footer-links-list">
					<li><a href="#">FAQs</a></li>
					<li><a href="#">Terms & Conditions</a></li>
					<li><a href="#">Privacy Policy</a></li>
					<li><a href="#">Forum Guidelines</a></li>
				</ul>
			</div>

			<!-- Column 4 -->
			<div class="footer-col">
				<h4>Address</h4>
				<ul class="footer-links-list address-list">
					<li>
						<!-- Envelope SVG -->
						<span
							style="margin-right: 8px; color: var(--brand-gold); vertical-align: middle;">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 512 512"
								fill="currentColor"
								width="1em"
								height="1em"
								><path
									d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"
								></path></svg
							>
						</span>
						<a href="mailto:info@theexclusiveoffers.vip"
							>info@theexclusiveoffers.vip</a
						>
					</li>
					<li>
						<!-- Phone SVG -->
						<span
							style="margin-right: 8px; color: var(--brand-gold); vertical-align: middle;">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 512 512"
								fill="currentColor"
								width="1em"
								height="1em"
								><path
									d="M164.9 24.6c-7.7-18.6-28-28.5-47.4-23.2l-88 24C12.1 30.2 0 46 0 64C0 311.4 200.6 512 448 512c18 0 33.8-12.1 38.6-29.5l24-88c5.3-19.4-4.6-39.7-23.2-47.4l-96-40c-16.3-6.8-35.2-2.1-46.3 11.6L304.7 368C234.3 334.7 177.3 277.7 144 207.3L193.3 167c13.7-11.2 18.4-30 11.6-46.3l-40-96z"
								></path></svg
							>
						</span>
						<a href="#">+123 1234 5678 90</a>
					</li>
					<li>
						<!-- Location Dot SVG -->
						<span
							style="margin-right: 8px; color: var(--brand-gold); vertical-align: middle;">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 384 512"
								fill="currentColor"
								width="1em"
								height="1em"
								><path
									d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"
								></path></svg
							>
						</span>
						<a href="#">Mailing Address</a>
					</li>
				</ul>
			</div>
		</div>
		<div class="footer-bottom-bar" style="justify-content: center;">
			<div class="copyright-text">
				&copy; 2025 EXECUTIVE Offers VIP. All rights reserved. 18+ Please gamble
				responsibly.
			</div>
		</div>
	</footer>
    <script>
        // Handle Newsletter Submission without Redirect
        const form = document.getElementById('newsletterForm') as HTMLFormElement;
        const message = document.getElementById('form-message');

        if (form && message) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                
                fetch('/', {
                    method: 'POST',
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams(formData as any).toString()
                })
                .then(() => {
                    message.style.display = 'block';
                    message.style.color = '#c69c3a';
                    message.innerText = 'Welcome to the club! Check your inbox soon.';
                    form.reset();
                })
                .catch((error) => {
                    message.style.display = 'block';
                    message.style.color = 'red';
                    message.innerText = 'Submission failed. Please try again.';
                });
            });
        }
    </script>
</Layout>
