---
import Layout from "../../layouts/Layout.astro";
import CasinoCard from "../../components/CasinoCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const geos = ["de", "at", "ca", "nz", "ie", "global"];
	return geos.map((geo) => ({ params: { geo } }));
}

const { geo } = Astro.params;
const allCasinos = await getCollection("casinos");

// Filter Logic
const filteredCasinos = allCasinos.filter((casino) => {
	const data = casino.data;
	const core = data.core_identity || {};
	const rankVis = data.ranking_visibility || {};

	// Handle isActive (Nested or Root fallback)
	const isActive = core.isActive ?? data.isActive ?? true;
	if (!isActive) return false;

	// Handle Targeting (Nested Group)
	const allowed = rankVis.targeting_group || data.allowed_geos || ["global"];

	return allowed.includes("global") || allowed.includes(geo);
});

// Sorting Logic
const sortedCasinos = filteredCasinos.sort((a, b) => {
	const rankVisA = a.data.ranking_visibility || {};
	const rankVisB = b.data.ranking_visibility || {};
	const metricsA = a.data.ratings_metrics || {};
	const metricsB = b.data.ratings_metrics || {};

	const rankA = rankVisA.rank ?? a.data.rank ?? 999;
	const rankB = rankVisB.rank ?? b.data.rank ?? 999;

	// Primary: Rank
	if (rankA !== rankB) {
		return rankA - rankB;
	}

	// Secondary: Rating
	const ratingA = metricsA.rating ?? a.data.rating ?? 0;
	const ratingB = metricsB.rating ?? b.data.rating ?? 0;

	return ratingB - ratingA;
});

const geoNames: Record<string, string> = {
	de: "Germany",
	at: "Austria",
	ca: "Canada",
	nz: "New Zealand",
	ie: "Ireland",
	global: "World",
};
const countryName = geoNames[geo] || "Global";
const currentMonth = new Date().toLocaleString("default", { month: "long" });
const currentYear = new Date().getFullYear();
const pageTitle = `Best Online Casinos in ${countryName} - ${currentMonth} ${currentYear}`;
---

<Layout title={pageTitle}>
	<!-- 1. STICKY HEADER -->
	<header class="site-header" id="siteHeader">
		<div class="nav-bar">
			<div class="brand-logo">
				<i class="fa-solid fa-crown"></i> EXECUTIVE OFFERS <span>.VIP</span>
			</div>
			<nav class="nav-links">
				<a href="#">Home</a>
                <a href="#">About Us</a>
				<a href="#">Bonuses</a>
				<a href="#">Reviews</a>
			</nav>
			<a href="#" class="btn-contact">Contact Us</a>
		</div>
	</header>

	<!-- 2. HERO SECTION -->
	<section class="hero-section">
		<div class="hero-container">
			<span class="pre-title">Find the best online casinos</span>
			<h1 class="hero-title">Welcome to Your VIP Casino Advantage</h1>
			<p class="hero-subtitle">
				We rigorously test and review thousands of casinos to bring you the
				safest, most lucrative VIP offers available in {countryName} for 2025.
			</p>
			<div class="stats-grid">
				<div class="stat-card">
					<span class="stat-number">500+</span>
					<span class="stat-label">Exclusive Bonuses</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">{sortedCasinos.length}</span>
					<span class="stat-label">Verified Casinos</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">150+</span>
					<span class="stat-label">Active Players</span>
				</div>
				<div class="stat-card">
					<span class="stat-number">24/7</span>
					<span class="stat-label">Expert Support</span>
				</div>
			</div>
		</div>
	</section>

	<!-- 3. MAIN CONTENT -->
	<main class="main-content-area">
		<div class="casino-list-container">
			<!-- List -->
			<div class="casino-list">
				{
					sortedCasinos.map((casino, index) => (
						<CasinoCard data={casino.data} index={index + 1} />
					))
				}
			</div>

			{
				sortedCasinos.length === 0 && (
					<div style="text-align:center; padding: 40px; color: #666;">
						No casinos found for this region.
					</div>
				)
			}
		</div>
	</main>

	<!-- 4. NEWSLETTER -->
	<section class="newsletter-section">
		<div class="newsletter-container">
			<h2 class="newsletter-heading">Join the Winners Circle</h2>
			<p class="newsletter-sub">
				Get exclusive high-roller bonuses and VIP codes sent directly to your
				inbox weekly.
			</p>
			<form class="newsletter-form" onsubmit="event.preventDefault();">
				<input
					type="email"
					placeholder="Enter your email address"
					class="newsletter-input"
					required
				/>
				<button type="submit" class="newsletter-btn">Get VIP Access</button>
			</form>
		</div>
	</section>

	<!-- 5. FOOTER -->
	<footer class="site-footer">
		<div class="footer-grid">
			<div class="footer-col footer-brand">
				<div class="brand-logo" style="color: var(--brand-gold);">
					<i class="fas fa-map-marker-alt"></i> EXECUTIVE OFFERS
				</div>
				<p>
					Discover top-rated online casinos with massive bonuses, secure
					gameplay, and fast payouts.
				</p>
				<div class="social-icons">
					<a href="#"><i class="fa-brands fa-twitter"></i></a>
					<a href="#"><i class="fa-brands fa-facebook-f"></i></a>
					<a href="#"><i class="fa-brands fa-instagram"></i></a>
					<a href="#"><i class="fa-brands fa-telegram"></i></a>
				</div>
			</div>
			<div class="footer-col">
				<h4>Quick Links</h4>
				<ul class="footer-links-list">
					<li><a href="#">Home</a></li>
					<li><a href="#">About Us</a></li>
					<li><a href="#">Bonuses</a></li>
					<li><a href="#">Reviews</a></li>
				</ul>
			</div>

			<div class="footer-col">
				<h4>Resources</h4>
				<ul class="footer-links-list">
					<li><a href="#">FAQs</a></li>
					<li><a href="#">Terms & Conditions</a></li>
					<li><a href="#">Privacy Policy</a></li>

					<li><a href="#">Forum Guidelines</a></li>
				</ul>
			</div>
			<div class="footer-col">
				<h4>Contact Us</h4>
				<ul class="footer-links-list">
					<li>
						<a href="mailto:info@theexclusiveoffers.vip"
						></a>info@theexclusiveoffers.vip
					</li>
					<li><a href="#">+123 1234 5678 90</a></li>
					<li><a href="#">Mailing Address</a></li>
				</ul>
			</div>
		</div>
		<div class="footer-bottom-bar">
			<div class="copyright-text">
				&copy; 2025 EXECUTIVE Offers VIP. All rights reserved. 18+ Please gamble
				responsibly.
			</div>
			
		</div>
	</footer>
</Layout>
